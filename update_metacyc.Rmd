---
title: "Generating MetaCyc SmartTable"
output: github_document
---

## Create Table 1: Compounds and IDs
1. Go to www.metacyc.org and log in.
2. Navigate to [SmartTables] -> [Special SmartTables].
3. Choose [All compounds of MetaCyc].
4. If you see a warning message, make sure you create a writeable copy of the SmartTable. You should then see three options: [Add Transform Column], [Add Property Column], and [Enrichments]. 
5. [Add Property Column] -> [Database Links]. Choose: 
    + [CAS]
    + [HMDB]
    + [KEGG LIGAND]
    + [PubChem-compound]
6. On the right-hand pane, under [Operations], choose [Export >] -> [> to Spreadsheet File], choose [frame IDs] as the "format type for values in spreadsheet", and export the SmartTable. 

## Start MetaCyc pathway-tools
1. Download and install pathway-tools (currently version 21.0)
2. Run pathway-tools, and in the visual interface click 'MetaCyc'

## Create Table 2: Reactions of Compounds
1. From the [SmartTables] menu dropdown choose [Create New SmartTable] -> [Containing All] -> [Compounds]
2. Once list of all compounds appears (currently 15950 Total), choose [SmartTables] -> [Transform SmartTable] -> [Reactions of Compounds]
3. Save the SmartTable: [SmartTables] -> [Export SmartTable] -> [Tab-delimited table], and select save directory & filename. 
4. When prompted, specify [Identifiers] as the export choice. 

## Create Table 3: Genes of Reactions
1. From the [SmartTables] menu dropdown choose [Create New SmartTable] -> [Containing All] -> [Reactions]
2. Once the list fo all reactions appears (currently 15311 Reactions), choose [SmartTables] -> [Transform SmartTable] -> [Genes of a Reaction]
3. Save the SmartTable: [SmartTables] -> [Export SmartTable] -> [Tab-delimited table], and select save directory & filename. 
4. When prompted, specify [Identifiers] as the export choice. 

## Create Table 4: Compounds and IDs
1. Go to www.metacyc.org and log in.
2. Navigate to [SmartTables] -> [Special SmartTables].
3. Choose [All genes of MetaCyc].
4. If you see a warning message, make sure you create a writeable copy of the SmartTable. You should then see three options: [Add Transform Column], [Add Property Column], and [Enrichments]. 
5. [Add Property Column] -> [Database Links]. Choose: 
    + [Ensembl Human]
    + [GeneCards] - Official Gene Symbol
6. On the right-hand pane, under [Operations], choose [Export >] -> [> to Spreadsheet File], choose [frame IDs] as the "format type for values in spreadsheet", and export the SmartTable. 

## Create Table 5: Pathways and Reactions
1. From the [SmartTables] menu dropdown choose [Create New SmartTable] -> [Containing All] -> [Pathways]
2. Once list of all compounds appears (currently 2903 Total), choose [SmartTables] -> [Transform SmartTable] -> [Reactions of pathway]
3. Save the SmartTable: [SmartTables] -> [Export SmartTable] -> [Tab-delimited table], and select save directory & filename. 
4. When prompted, specify [Identifiers] as the export choice. 

## Munge Tables

Unfortunately, all of these tables require munging! The have been formatted for display with HTML entities and anchor tags. 
```{r}
library(tidyverse)
library(stringr)
library(magrittr)
library(rprojroot)

rootDir <- rprojroot::find_rstudio_root_file()
updateDir <- file.path(rootDir, 'database_updates')
exampleDir <- file.path(rootDir, 'example_data')

compoundIDs <- read_tsv(file.path(updateDir, '1_compounds_and_IDs.tsv'))

compoundIDs %<>% 
  # Create new columns that represent 'web' columns
  mutate(webHMDB = HMDB) %>% mutate(webCAS = CAS) %>% 
  mutate(webKEGG = KEGG) %>% mutate(webPubChem = PubChem) %>% 
  # Strip out opening anchor tag
  mutate(HMDB = str_replace(HMDB, "^<a href='.*'>", "")) %>% 
  mutate(CAS = str_replace(CAS, "^<a href='.*'>", "")) %>% 
  mutate(KEGG = str_replace(KEGG, "^<a href='.*'>", "")) %>% 
  mutate(PubChem = str_replace(PubChem, "^<a href='.*'>", "")) %>% 
  # Strip out closing anchor tag
  mutate(HMDB = str_replace(HMDB, "<\\/a>$", "")) %>% 
  mutate(CAS = str_replace(CAS, "<\\/a>$", "")) %>% 
  mutate(KEGG = str_replace(KEGG, "<\\/a>$", "")) %>% 
  mutate(PubChem = str_replace(PubChem, "<\\/a>$", "")) %>% 
  # Make sure there is no trailing whitespace
  mutate(HMDB = str_trim(HMDB)) %>% 
  mutate(CAS = str_trim(CAS)) %>% 
  mutate(KEGG = str_trim(KEGG)) %>% 
  mutate(PubChem = str_trim(PubChem))
```

Looks good for the first dataset. Let's give it a test!
```{r}
lactate <- read_csv(file.path(exampleDir, 'lactate.csv'))


# MetaCyc only supports the older format, 5 digit HMDB IDs. If we detect your
# HMDB IDs are in the newer 7 digit formar, we will trim the leading characters
# if they are zeros. If they are not zeros, we will return an error.
matchHMDB <- function(hmdbID) {
  # Make sure the ID is a character amd starts with 'HMDB' or 'hmdb'
  # Look at the syntax very carefully here, the parens are IMPORTANT
  if (!is.character(hmdbID) | !(str_detect(hmdbID, '^HMDB') | str_detect(hmdbID, '^hmdb'))) {
    return(NA)
  # If the ID is in the new, 7 digit format, check the leading digits
  } else if (nchar(hmdbID) == 11) {
    # If the leading characters are 00, simply trim the string
    if (str_sub(hmdbID, start = 5, end = 6) == '00') {
      newID <- paste0('HMDB', str_sub(hmdbID, start = -5, end = -1))
      return(newID)
      # Otherwise, return an error
    } else {
      return(NA)
    }
    # Otherwise, if the ID is in the older, 5-digit format, simply return the ID as-is.
  } else if (nchar(hmdbID) == 9) {
    # Do this **anyways** because it'll ensure we have capital letters at the start of the ID
    newID <- paste0('HMDB', str_sub(hmdbID, start = -5, end = -1))
    return(newID)
    # If there is an edge case where the ID is not 9 or 11 charactesr in length(), also return NA
  } else {
    return(NA)
  }
}

matchHMDB('HMDB0000190')  # HMDB00190
matchHMDB('HMDB00190')    # HMDB00190
matchHMDB(200)            # NA
matchHMDB('HMDB00000190') # NA
matchHMDB('superlong')    # NA
matchHMDB('hmdb0000190')  # HMDB00190
matchHMDB('hmdb00190')    # HMDB00190
matchHMDB('hmdbWRONG')    # hmdbWRONG # not currently supporting EVERY edge case

compoundIDs %>% 
  filter(HMDB == matchHMDB('HMDB0000190'))

compoundIDs %>% 
  filter(HMDB == matchHMDB(lactate$hmdbID[1]))
```

